---
- name: Install odoo
  import_role:
    name: lokal
    tasks_from: install
  vars:
    app: odoo
    app_domain: "{{odoo_domain}}"
    app_port: 8069
    app_version: 17
    data_dirs:
    - data
    - config
    - addons
    start: false # you can postpone starting (by defaults the container starts)

# Just create a DB user with DBCREATE permission because that's how Odoo requires it
- name: Create {{app_domain}} PostgreSQL user
  ansible.builtin.shell:
    cmd: >
      docker compose exec postgres
      psql -c "CREATE USER {{odoo_db_user}} WITH NOSUPERUSER CREATEDB PASSWORD '{{odoo_db_password}}'" postgres postgres;
    chdir: "{{project_root}}/lokal"
  ignore_errors: yes

- name: Render odoo config
  ansible.builtin.template:
    src: "odoo.conf"
    dest: "{{app_root}}/config/odoo.conf"

- name: Start the app
  ansible.builtin.shell:
    cmd: "docker compose up -d"
    chdir: "{{app_root}}"
