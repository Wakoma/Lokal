{% if "users" in services %}
auth.ldap ldap {
    urls ldap://ldap:{{ldap_port}}

    # Specify initial bind credentials. Not required ('bind off')
    # if DN template is used.
    bind plain "cn={{admin_user}},ou=people,{{ldap_domain}}" "{{admin_password}}"

    # Specify DN template to skip lookup.
    dn_template "cn={username},ou=people,{{ldap_domain}}"

    starttls off
    debug {% if debug %}on{% else %}off{% endif %}
    connect_timeout 10s
}{% endif %}

tls file /etc/ssl/mail.{{domain}}.crt /etc/ssl/mail.{{domain}}.key {
    protocols tls1.2 tls1.3
}

storage.imapsql local_mailboxes {
    driver sqlite3
    dsn mail.db
}

imap tcp://0.0.0.0:143 tls://0.0.0.0:993 {
    io_debug {% if debug %}on{% else %}off{% endif %}
    debug {% if debug %}on{% else %}off{% endif %}
    # even though this is on, we only export the :993 port that should require TLS
    insecure_auth on
{% if "users" in services %}
    auth &ldap
{% endif %}
    storage &local_mailboxes
    # auth_map identity
    # auth_map_normalize auto
    # storage_map identity
    # storage_map_normalize auto
}

smtp tcp://0.0.0.0:25 tls://0.0.0.0:465 {
    hostname mail.{{domain}}
    io_debug {% if debug %}on{% else %}off{% endif %}
    debug {% if debug %}on{% else %}off{% endif %}
    # even though this is on, we only export the :465 port that should require TLS
    insecure_auth on
    read_timeout 10m
    write_timeout 1m
    max_message_size 32M
    max_header_size 1M
{% if "users" in services %}
    auth &ldap
{% endif %}
    defer_sender_reject yes
    dmarc yes
    smtp_max_line_length 4000

    # Example pipeline ocnfiguration.
    destination {{domain}} {
        deliver_to &local_mailboxes
    }
    default_destination {
        reject
    }
}