---
- name: Deploy Moodle
  hosts: all
  tasks:

    - name: Register primary user's details
      user:
        name: "{{ primary_ssh_user }}"
      register: primary_ssh_user_params

    - name: Set facts
      set_fact:
        lokal_dir: "{{ primary_ssh_user_params.home }}/Lokal"
        moodle_dir: "{{ primary_ssh_user_params.home }}/moodle"

    - name: Make Moodle installation directory
      file:
        path: "{{ moodle_dir }}"
        state: directory

    - name: resolve .envrc.quickstart variables
      ansible.builtin.shell: . ../../.envrc.quickstart && env 2> /dev/null
      args:
        executable: /bin/bash
      register: envrc_out

    - name: Parse environment
      set_fact:
        envrc: "{{ ('{' + envrc_out.stdout_lines | map('regex_replace', '([^=]*)=(.*)', '\"\\1\": \"\\2\"') | join(',') + '}') | from_json }}"

    - name: Set facts
      set_fact:
        domain_moodle: "moodle.{{ lookup('env', 'DOMAIN') }}"
        cert_resolver: "{{ lookup('env', 'CERT_RESOLVER') | default('dns', true) }}"
        server_is_public: "{{ lookup('env', 'SERVER_IS_PUBLIC') | default(false, true) }}"

    - name: Copy .env from template
      ansible.builtin.template:
        src: "{{ lokal_dir }}/config/services/moodle/.env.j2"
        dest: "{{ moodle_dir }}/.env"
        mode: "0600"

    - name: Copy docker-compose.yml from template
      ansible.builtin.template:
        src: "{{ lokal_dir }}/config/services/moodle/docker-compose.yml.j2"
        dest: "{{ moodle_dir }}/docker-compose.yml"
        mode: "0600"

    - name: Docker-compose up
      shell: "docker-compose up --quiet-pull -d"
      args:
        chdir: "{{ moodle_dir }}"
